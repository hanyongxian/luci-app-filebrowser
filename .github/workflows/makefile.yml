name: Build OpenWrt FileBrowser IPK
on:
  workflow_dispatch: # 仅手动触发，避免误执行
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-filebrowser-ipk.yml' # 仅修改此文件时自动触发

jobs:
  build-ipk:
    runs-on: ubuntu-22.04
    steps:
      - name: 清理环境&安装依赖
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt update -y && sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget curl
          sudo timedatectl set-timezone Asia/Shanghai

      - name: 拉取OpenWrt源码&加速
        run: |
          git config --global url."https://ghproxy.com/https://github.com/".insteadOf "https://github.com/"
          git clone --depth=1 --branch openwrt-23.05 https://git.openwrt.org/openwrt/openwrt.git openwrt
          cd openwrt
          # 添加常用源，确保FileBrowser插件可拉取
          echo 'src-git small8 https://github.com/kenzok8/small-package' >> feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 配置编译参数（仅适配armvirt64/N1盒子）
        run: |
          cd openwrt
          cat > .config << EOF
          CONFIG_TARGET_armvirt=y
          CONFIG_TARGET_armvirt_64=y
          CONFIG_TARGET_armvirt_64_Default=y
          CONFIG_TARGET_ARCH_PACKAGES="aarch64_cortex-a53"
          CONFIG_CPU_TYPE="cortex-a53"
          # 启用FileBrowser核心及LuCI界面
          CONFIG_PACKAGE_luci-app-filebrowser=y
          CONFIG_PACKAGE_filebrowser=y
          # 基础依赖（必选）
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_opkg=y
          EOF
          make defconfig

      - name: 编译FileBrowser IPK（仅编译插件，提速）
        run: |
          cd openwrt
          make package/luci-app-filebrowser/compile V=s
          make package/filebrowser/compile V=s
          # 清理冗余文件，仅保留IPK
          find bin/packages -name "*.ipk" -type f | grep -E "filebrowser|luci-app-filebrowser" > ipk-list.txt

      - name: 上传编译好的IPK
        uses: actions/upload-artifact@v4
        with:
          name: filebrowser-ipk-armvirt64
          path: |
            openwrt/bin/packages/**/filebrowser*.ipk
            openwrt/bin/packages/**/luci-app-filebrowser*.ipk
          retention-days: 7 # 成品保留7天，可按需修改
