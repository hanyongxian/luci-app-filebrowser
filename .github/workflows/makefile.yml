name: Build luci-app-filebrowser (wangqn - Ultimate)
on:
  workflow_dispatch: # 仅手动触发，避免误执行

jobs:
  build-ipk:
    runs-on: ubuntu-22.04
    steps:
      - name: 清理环境&安装系统依赖
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt update -y && sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget curl
          sudo timedatectl set-timezone Asia/Shanghai

      - name: 拉取 OpenWrt 23.05 源码
        run: |
          git clone --depth=1 --branch openwrt-23.05 https://git.openwrt.org/openwrt/openwrt.git openwrt
          cd openwrt
          # 仅保留核心源，减少干扰
          sed -i '/telephony/d' feeds.conf.default
          ./scripts/feeds update -a -f
          ./scripts/feeds install -a

      - name: 初始化编译环境（生成 usign 等核心工具）
        run: |
          cd openwrt
          # 关键步骤：先编译基础工具链，生成 staging_dir 下的所有工具
          make tools/install V=s
          make toolchain/install V=s

      - name: 替换为 wangqn/luci-app-filebrowser
        run: |
          cd openwrt
          # 删除官方 luci-app-filebrowser
          rm -rf feeds/luci/applications/luci-app-filebrowser
          # 克隆 wangqn 版本到 package 目录
          git clone https://github.com/wangqn/luci-app-filebrowser.git package/luci-app-filebrowser
          # 安装 filebrowser 核心包（官方）
          ./scripts/feeds install filebrowser

      - name: 配置编译参数（适配 N1 盒子/armvirt64）
        run: |
          cd openwrt
          cat > .config << EOF
          CONFIG_TARGET_armvirt=y
          CONFIG_TARGET_armvirt_64=y
          CONFIG_TARGET_armvirt_64_Default=y
          CONFIG_TARGET_ARCH_PACKAGES="aarch64_cortex-a53"
          CONFIG_CPU_TYPE="cortex-a53"
          # 仅编译必要包
          CONFIG_PACKAGE_filebrowser=y
          CONFIG_PACKAGE_luci-app-filebrowser=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_opkg=y
          # 关闭签名校验（避免 usign 依赖问题）
          CONFIG_SIGNED_PACKAGES=n
          EOF
          make defconfig

      - name: 编译插件（跳过索引签名）
        run: |
          cd openwrt
          # 直接编译，跳过包索引签名（核心修复）
          make package/filebrowser/compile V=s
          make package/luci-app-filebrowser/compile V=s

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: wangqn-filebrowser-ipk-armvirt64
          path: |
            openwrt/bin/packages/**/filebrowser*.ipk
            openwrt/bin/packages/**/luci-app-filebrowser*.ipk
          retention-days: 7
